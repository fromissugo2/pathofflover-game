<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Path of flover</title>

  <script src="https://cdn.jsdelivr.net/npm/phaser@3.80.1/dist/phaser.min.js"></script>

  <style>
    body {
      margin: 0;
      background: #ffffff;
    }
  </style>
</head>
<body>

<script>
/* ===============================
   ê¸°ë³¸ ì„¤ì •
=============================== */
const WIDTH = 800;
const HEIGHT = 400;
const GROUND_Y = 320;

let player, obstacle, ground;
let gameState = "IDLE";

/* ===============================
   Phaser ì„¤ì •
=============================== */
const config = {
  type: Phaser.AUTO,
  width: WIDTH,
  height: HEIGHT,
  backgroundColor: "#ffffff",
  physics: {
    default: "arcade",
    arcade: {
      gravity: { y: 900 },
      debug: false
    }
  },
  render: {
    pixelArt: true,
    antialias: false
  },
  scene: {
    preload,
    create,
    update
  }
};

new Phaser.Game(config);

/* ===============================
   preload
=============================== */
function preload() {
  // ìºë¦­í„°
  this.load.image("player_idle", "assets/characters/flover_idle.jpg");
  this.load.image("player_jump", "assets/characters/flover_jump.jpg");
  this.load.image("player_fail", "assets/characters/flover_fail.jpg");

  // í—ˆë“¤
  this.load.image("hurdle", "assets/obstacles/hurdle.png");

  // ë°”ë‹¥
  this.load.image("ground", "assets/terrain/ground.png");
}

/* ===============================
   create
=============================== */
function create() {

  /* ë°”ë‹¥ */
  ground = this.physics.add.staticSprite(
    WIDTH / 2,
    GROUND_Y + 20,
    "ground"
  );
  ground.setScale(2);
  ground.refreshBody();

  /* í”Œë ˆì´ì–´ */
  player = this.physics.add.sprite(
    600,
    GROUND_Y - 40,
    "player_idle"
  );
  player.setScale(2);
  player.setCollideWorldBounds(true);
  player.jumped = false;

  /* ===============================
     í—ˆë“¤ (í¬ê¸° ì •ê·œí™” í•µì‹¬)
  =============================== */
  obstacle = this.physics.add.sprite(
    150,
    GROUND_Y - 20,
    "hurdle"
  );

  // ðŸŽ¯ ëª©í‘œ í—ˆë“¤ ë†’ì´ (í”½ì…€ ê¸°ì¤€)
  const TARGET_HURDLE_HEIGHT = 26;

  // ì›ë³¸ ì´ë¯¸ì§€ ê¸°ì¤€ ìžë™ ìŠ¤ì¼€ì¼
  const hurdleScale = TARGET_HURDLE_HEIGHT / obstacle.height;
  obstacle.setScale(hurdleScale);

  obstacle.body.setAllowGravity(false);
  obstacle.body.setImmovable(true);
  obstacle.setVelocity(0, 0);

  // ížˆíŠ¸ë°•ìŠ¤ = ë³´ì´ëŠ” í¬ê¸° ê¸°ì¤€
  obstacle.body.setSize(
    obstacle.displayWidth * 0.9,
    obstacle.displayHeight * 0.8
  );
  obstacle.body.setOffset(
    obstacle.displayWidth * 0.05,
    obstacle.displayHeight * 0.2
  );

  /* ì¶©ëŒ */
  this.physics.add.collider(player, ground);
  this.physics.add.collider(obstacle, ground);

  this.physics.add.collider(player, obstacle, () => {
    if (gameState === "FAIL") {
      player.setVelocity(0);
      player.setTexture("player_fail");
      player.setAngle(90);
      resetScene(this);
    }
  });

  /* ì•ˆë‚´ */
  this.add.text(20, 20, "ì½˜ì†”ì—ì„œ correct() / wrong()", {
    font: "16px Arial",
    fill: "#000"
  });
}

/* ===============================
   update
=============================== */
function update() {

  /* í—ˆë“¤ ì´ë™ */
  if (gameState === "SUCCESS" || gameState === "FAIL") {
    obstacle.setVelocityX(200);
  }

  /* ì í”„ íƒ€ì´ë° */
  if (
    (gameState === "SUCCESS" || gameState === "FAIL") &&
    !player.jumped &&
    obstacle.x >= player.x - 80
  ) {
    player.jumped = true;
    player.setTexture("player_jump");

    if (gameState === "SUCCESS") {
      player.setVelocityY(-380);
    } else {
      player.setVelocityY(-260);
      setTimeout(() => {
        player.setTexture("player_fail");
        player.setAngle(90);
      }, 350);
    }
  }

  /* ì°©ì§€ í›„ ëŒ€ê¸° */
  if (player.body.blocked.down && gameState === "IDLE") {
    player.setTexture("player_idle");
    player.setAngle(0);
  }

  /* ì„±ê³µ í›„ ë¦¬ì…‹ */
  if (gameState === "SUCCESS" && obstacle.x > player.x + 60) {
    resetScene(this);
  }
}

/* ===============================
   ì •ë‹µ / ì˜¤ë‹µ
=============================== */
window.correct = function () {
  if (gameState !== "IDLE") return;
  gameState = "SUCCESS";
};

window.wrong = function () {
  if (gameState !== "IDLE") return;
  gameState = "FAIL";
};

/* ===============================
   ë¦¬ì…‹
=============================== */
function resetScene(scene) {
  setTimeout(() => {
    gameState = "IDLE";
    scene.scene.restart();
  }, 700);
}
</script>

</body>
</html>
